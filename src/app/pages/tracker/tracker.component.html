<div class="background-container">
  <div class="overlay">
    <div class="card">
      <div class="head">
        {{
        showWeeklyOverview
        ? "Weekly Overview"
        : showExpenseForm
        ? "Add Expense"
        : "Expense Tracker"
        }}
      </div>
      <div class="content">
        <ng-container *ngIf="!showWeeklyOverview">
          <!-- Tabs for weekdays -->
          <div class="tabs">
            <button *ngFor="let day of days" class="tab-button" [class.active]="selectedDay === day"
              (click)="selectedDay = day; getExpensesByDay(selectedDay)" [disabled]="isFutureDay(day)">
              {{ day }}
            </button>
          </div>

          <div class="button-bar">
            <button class="button" (click)="toggleExpenseForm()">
              {{ showExpenseForm ? "Back" : "Add Expense" }}
            </button>
            <!-- <button class="button save-button" *ngIf="showExpenseForm" (click)="saveExpense(selectedDay)">Save</button> -->
            <button class="button save-button" (click)="toggleWeeklyOverview()">
              Weekly Overview
            </button>
          </div>

          <!-- Expense Form -->
          <ng-container *ngIf="showExpenseForm">
            <div class="expense-form">
              <h3>Expenses for {{ selectedDay }}</h3>

              <label>Expense Name:</label>
              <input #expName [(ngModel)]="expenseName" (change)="
                  isEditing ? validateFormAtUpdate() : validateFormAtSave()
                " type="text" placeholder="Enter expense name" />

              <label>Add or select category
                <button class="add-category-button" (click)="toggleCategoryPopup()">+</button>
              </label>
              <div class="category-container">
                <select #expCategory [(ngModel)]="selectedCategory" (change)="
                    isEditing ? validateFormAtUpdate() : validateFormAtSave()
                  " required>
                  <option value="" disabled selected>Select Category</option>
                  <option *ngFor="let category of categories" [value]="category.name">
                    {{ category.name }}
                  </option>
                </select>
              </div>

              <div *ngIf="showCategoryPopup" class="category-popup-overlay">
                <div class="category-popup">
                  <h3>Manage Categories</h3>
                  <input type="text" [(ngModel)]="newCategory" placeholder="Enter new category" />
                  <button class="button" (click)="addCategory()">Add</button>

                  <ul class="category-list">
                    <li *ngFor="let category of categories">
                      <span *ngIf="editingCategory !== category.id">{{ category.name }}</span>
                      <input *ngIf="editingCategory === category.id" type="text" [(ngModel)]="editedCategory" />

                      <div class="category-buttons">
                        <button class="edit-btn" *ngIf="editingCategory !== category.id && !category.isDefault"
                          (click)="editCategory(category)">Edit</button>
                        <button class="save-btn" *ngIf="editingCategory === category.id"
                          (click)="saveEditedCategory()">Save</button>
                        <button class="delete-btn" *ngIf="!category.isDefault"
                          (click)="deleteCategory(category)">Delete</button>
                      </div>
                    </li>
                  </ul>

                  <button class="button cancel-button" (click)="toggleCategoryPopup()">
                    Cancel
                  </button>
                </div>
              </div>

              <label>Amount:</label>
              <input #expAmount [(ngModel)]="expenseAmount" type="number" (change)="
                  isEditing ? validateFormAtUpdate() : validateFormAtSave()
                " placeholder="Enter an amount" (input)="validateAmount($event)" (keypress)="onKeyPress($event)"
                step="0.01" min="0.01" />
            </div>
          </ng-container>

          <!-- Expense List -->
          <ng-container *ngIf="!showExpenseForm">
            <div class="expense-list">
              <h4>Existing Expenses</h4>
              <div class="expense-item" *ngFor="let _expense of dailyExpenses">
                <div class="expense-info">
                  <span class="expense-name">{{ _expense.name }}</span>
                  <span class="expense-category">{{ _expense.category.name }}</span>
                </div>
                <div class="expense-amount">
                  {{ _expense.amount }} €
                  <button class="edit-btn" (click)="editExpense(_expense)" (click)="toggleExpenseForm()">
                    Edit
                  </button>
                  <button class="delete-btn" (click)="deleteExpense(_expense.id)">
                    Delete
                  </button>
                </div>
              </div>
            </div>
          </ng-container>

          <!--                            <label>Amount:</label>
                            <input #expAmount type="number" placeholder="Enter an amount"
                                (input)="validateAmount($event)" (keypress)="onKeyPress($event)" step="0.01"
                                min="0.01" /> -->
          <!--                         </div> -->
          <!--                     </ng-container> -->

          <button [disabled]="isSaveDisabled" class="weekly-overview-button" *ngIf="showExpenseForm"
            (click)="isEditing ? updateExpense() : saveExpense(selectedDay)">
            {{ isEditing ? "Update" : "Save" }}
          </button>
        </ng-container>

        <ng-container *ngIf="showWeeklyOverview">
          <h2>
            Total Weekly Expenses: {{ getWeeklyTotal() | number : "1.2-2" }}
          </h2>
          <ul class="week-summary">
            <li *ngFor="let day of days" (click)="toggleDayExpenses(day)" class="clickable-day">
              {{ day }}: {{ dailyTotals[day] | number : "1.2-2" }} €

              <div *ngIf="expendedDays[day]" class="expense-list">
                <h4>Expenses for {{ day }}</h4>

                <div *ngIf="expendedDayExpenses[day]?.length">
                  <div class="expense-item" *ngFor="let _expense of expendedDayExpenses[day]">
                    <div class="expense-info">
                      <span class="expense-name">{{ _expense.name }}</span>
                      <span class="expense-category">{{ _expense.category.name }}</span>
                    </div>
                    <div class="expense-amount">
                      {{ _expense.amount | number : "1.2-2" }} €
                    </div>
                  </div>
                </div>

                <p *ngIf="expendedDayExpenses[day]?.length === 0">
                  No expenses recorded for {{ day }}
                </p>
              </div>
            </li>
          </ul>

          <button class="button" (click)="toggleWeeklyOverview()">
            Back to Tracker
          </button>
        </ng-container>

      </div>
    </div>
  </div>
</div>